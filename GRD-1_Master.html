<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GRD-1 Master v8 (with ReadMe + Ghostwatch branching)</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
html,body{
  margin:0;
  background:#000;
  height:100%;
  display:flex;
  justify-content:center;
  align-items:center;
  overflow:hidden;
  font-family:'Press Start 2P',monospace;
}
#frame{
  width:800px;
  height:600px;
  border:2px solid #aaffcc;
  background:#000;
  position:relative;
  overflow:hidden;
  box-shadow:0 0 25px #aaffcc,0 0 50px #aaffcc;
  transition:box-shadow 10s ease,border-color 10s ease;
}
iframe{
  width:100%;
  height:100%;
  border:none;
  display:block;
}
.transition{
  position:absolute;
  inset:0;
  z-index:999;
  background:#000;
  pointer-events:none;
  opacity:0;
}
@keyframes glitch2{
  0%{opacity:0;}
  10%{opacity:1;background:linear-gradient(0deg,#00f 0%,#000 10%,#00f 20%,#000 30%,#00f 40%,#000 50%,#00f 60%,#000 70%,#00f 80%,#000 100%);}
  30%{filter:hue-rotate(60deg);}
  50%{transform:translateX(5px);}
  70%{transform:translateX(-5px);}
  100%{opacity:0;}
}
@keyframes glitch3{
  0%{opacity:0;}
  20%{opacity:1;background:repeating-linear-gradient(180deg,#0f0 0 4px,#000 4px 8px);}
  40%{filter:blur(2px);}
  60%{transform:scaleY(1.1);}
  80%{opacity:0.6;}
  100%{opacity:0;}
}
@keyframes glitch4{
  0%{opacity:0;}
  25%{opacity:1;background:#f00;}
  50%{filter:blur(3px);}
  75%{opacity:1;background:#800;}
  100%{opacity:0;}
}
</style>
</head>
<body>
<div id="frame">
  <iframe id="viewer" src="https://behindthecurtains.github.io/GRD-1_Live/GRD-1_0.html"></iframe>
  <div id="transition" class="transition"></div>
</div>
<script>
const experiences=[
 "https://behindthecurtains.github.io/GRD-1_Live/GRD-1_0.html",
 "https://behindthecurtains.github.io/GRD-1_Live/GRD-1_A.html",
 "https://behindthecurtains.github.io/GRD-1_Live/GRD-1_B.html",
 "https://behindthecurtains.github.io/GRD-1_Live/GRD-1_C.html",
 "https://behindthecurtains.github.io/GRD-1_Live/GRD-1_D.html"
];
const readmeURL="https://behindthecurtains.github.io/GRD-1_Live/GRD-1_ReadMeReturn.html";

let current=0;
const iframe=document.getElementById('viewer');
const trans=document.getElementById('transition');
const frame=document.getElementById('frame');

const ambiColors=["#aaffcc","#c41616","#66a3ff","#aaffcc"];
function setAmbilight(color){
  frame.style.borderColor=color;
  frame.style.boxShadow=`0 0 25px ${color},0 0 50px ${color}`;
}
setAmbilight(ambiColors[0]);

function playGlitchSound(type){
  try{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const osc=ctx.createOscillator();
    const gain=ctx.createGain();
    osc.connect(gain).connect(ctx.destination);
    switch(type){
      case 1: osc.type="square"; osc.frequency.setValueAtTime(800,ctx.currentTime);
              osc.frequency.exponentialRampToValueAtTime(50,ctx.currentTime+0.2); break;
      case 2: osc.type="sawtooth"; osc.frequency.setValueAtTime(200,ctx.currentTime);
              osc.frequency.linearRampToValueAtTime(400,ctx.currentTime+0.3); break;
      case 3: osc.type="triangle"; osc.frequency.setValueAtTime(150,ctx.currentTime);
              osc.frequency.exponentialRampToValueAtTime(30,ctx.currentTime+0.4); break;
      case 4: osc.type="square"; osc.frequency.setValueAtTime(60,ctx.currentTime);
              osc.frequency.linearRampToValueAtTime(5,ctx.currentTime+0.3); break;
    }
    gain.gain.setValueAtTime(0.3,ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.5);
    osc.start(); osc.stop(ctx.currentTime+0.5);
  }catch(e){console.warn("Audio ctx err",e);}
}

function dataCollapseEffect(){
  const cols=30;
  for(let i=0;i<cols;i++){
    const bar=document.createElement('div');
    bar.style.position='absolute';
    bar.style.width='20px';
    bar.style.height='100%';
    bar.style.left=(i*(800/cols))+'px';
    bar.style.background='linear-gradient(to bottom, rgba(100,205,136,0.8), rgba(0,0,0,0))';
    bar.style.filter='blur(3px)';
    bar.style.opacity='0.5';
    bar.style.transform='translateY(-100%)';
    bar.style.transition=`transform 1.2s ease-in ${Math.random()*0.3}s, opacity 1.2s ease-in ${Math.random()*0.3}s`;
    trans.appendChild(bar);
    setTimeout(()=>{
      bar.style.transform='translateY(100%)';
      bar.style.opacity='0';
    },50);
  }
  setTimeout(()=>{trans.innerHTML='';},1500);
}

function playTransition(num,nextSrc){
  playGlitchSound(num);
  frame.style.transition='box-shadow 0.4s ease, border-color 0.4s ease';
  setAmbilight('black');

  trans.style.opacity=1;
  dataCollapseEffect();
  setTimeout(()=>{iframe.src=nextSrc;},600);
  setTimeout(()=>{
    trans.style.opacity=0;
    frame.style.transition='box-shadow 10s ease, border-color 10s ease';
    setAmbilight(ambiColors[num % ambiColors.length]);
  },1500);
}

/* Listen for messages from child iframes */
window.addEventListener("message",(e)=>{
  const msg=e.data;
  switch(msg){
    case "openReadMe":
    case "openReadMeB":
      playTransition(1,"https://behindthecurtains.github.io/GRD-1_Live/GRD-1_ReadMeB.html");
      break;
    case "launchGhostwatch":
      current=1;
      playTransition(1,experiences[current]);
      break;
    case "experienceComplete":
      current++;
      if(current<experiences.length){
        playTransition(current,experiences[current]);
      }
      break;
    case "attemptReboot":
      current=0;
      playTransition(4,experiences[0]);
      break;
  }
});
</script>
</body>
</html>
